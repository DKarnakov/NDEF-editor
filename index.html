<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор SmartPoster для NTAG216</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #4a6ee0 0%, #6a4a9c 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 40px;
        }

        .form-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.4em;
            color: #4a6ee0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="url"],
        textarea,
        select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #4a6ee0;
            background: white;
            box-shadow: 0 0 0 3px rgba(74, 110, 224, 0.1);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: monospace;
            font-size: 14px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-group input {
            width: 18px;
            height: 18px;
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 200px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a6ee0 0%, #6a4a9c 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(74, 110, 224, 0.3);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #555;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .preview-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            border-left: 4px solid #4a6ee0;
        }

        .preview-section h3 {
            color: #4a6ee0;
            margin-bottom: 15px;
        }

        .preview-section pre {
            background: white;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 14px;
            font-family: monospace;
            border: 1px solid #e0e0e0;
            max-height: 300px;
            overflow-y: auto;
        }

        .hex-view {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .hex-row {
            display: flex;
            margin-bottom: 5px;
        }

        .hex-offset {
            color: #666;
            width: 60px;
            flex-shrink: 0;
        }

        .hex-bytes {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
        }

        .hex-byte {
            width: 24px;
            text-align: center;
            font-family: monospace;
        }

        .hex-ascii {
            margin-left: 20px;
            color: #888;
            font-family: monospace;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .info-box {
            background: #e8f4ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
            border-left: 4px solid #4a6ee0;
        }

        .required {
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            header {
                padding: 30px 20px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Генератор SmartPoster для NTAG216</h1>
            <p>Создайте файл .bin с записью типа SmartPoster для меток NTAG216</p>
        </header>

        <div class="main-content">
            <div class="info-box">
                <strong>Информация:</strong> SmartPoster - это тип записи NFC, который объединяет несколько полей: URI, заголовок, действие, тип и другие метаданные. NTAG216 имеет 888 байт памяти, что позволяет хранить комплексные записи.
            </div>

            <div class="form-section">
                <h2 class="section-title">Основные параметры SmartPoster</h2>
                
                <div class="form-group">
                    <label for="uri">URI <span class="required">*</span></label>
                    <input type="url" id="uri" placeholder="https://example.com" 
                           value="https://www.google.com" required>
                    <small>Укажите полный URL (например, https://, tel:, mailto:)</small>
                </div>

                <div class="form-group">
                    <label for="title">Заголовок (Title)</label>
                    <input type="text" id="title" placeholder="Введите заголовок" 
                           value="Открыть Google">
                </div>

                <div class="form-group">
                    <label for="action">Действие (Action)</label>
                    <select id="action">
                        <option value="0x00">Do the action (выполнить действие)</option>
                        <option value="0x01">Save for later (сохранить на потом)</option>
                        <option value="0x02">Open for editing (открыть для редактирования)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="mimeType">MIME тип</label>
                    <input type="text" id="mimeType" placeholder="text/html" 
                           value="text/html">
                    <small>Тип контента, на который ссылается URI</small>
                </div>
            </div>

            <div class="form-section">
                <h2 class="section-title">Дополнительные параметры</h2>
                
                <div class="form-group">
                    <label for="language">Язык заголовка</label>
                    <input type="text" id="language" placeholder="en" value="ru" 
                           maxlength="2">
                </div>

                <div class="form-group">
                    <label for="size">Размер данных (в байтах)</label>
                    <input type="text" id="size" placeholder="0" value="1024">
                </div>

                <div class="form-group">
                    <label for="encoding">Кодировка текста</label>
                    <select id="encoding">
                        <option value="UTF-8">UTF-8</option>
                        <option value="UTF-16">UTF-16</option>
                    </select>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="includeIcon" checked>
                    <label for="includeIcon">Включить информацию об иконке</label>
                </div>

                <div class="form-group" id="iconGroup">
                    <label for="iconUri">URI иконки</label>
                    <input type="url" id="iconUri" placeholder="https://example.com/icon.png" 
                           value="https://www.google.com/favicon.ico">
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="readOnly" checked>
                    <label for="readOnly">Сделать запись только для чтения</label>
                </div>
            </div>

            <div class="status-message" id="statusMessage"></div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="generateBinFile()">
                    Сгенерировать .bin файл
                </button>
                <button class="btn btn-secondary" onclick="previewStructure()">
                    Показать структуру
                </button>
                <button class="btn btn-secondary" onclick="resetForm()">
                    Сбросить форму
                </button>
            </div>

            <div class="preview-section" id="previewSection" style="display: none;">
                <h3>Предпросмотр структуры NDEF</h3>
                <pre id="structurePreview"></pre>
            </div>

            <div class="preview-section" id="hexPreviewSection" style="display: none;">
                <h3>Hex предпросмотр .bin файла</h3>
                <div class="hex-view" id="hexPreview"></div>
            </div>
        </div>
    </div>

    <script>
        // Показ/скрытие поля иконки
        document.getElementById('includeIcon').addEventListener('change', function() {
            document.getElementById('iconGroup').style.display = this.checked ? 'block' : 'none';
        });

        // Инициализация скрытия поля иконки если не выбрано
        document.getElementById('iconGroup').style.display = 
            document.getElementById('includeIcon').checked ? 'block' : 'none';

        // Функции для работы с бинарными данными
        class BinGenerator {
            constructor() {
                this.data = new ArrayBuffer(888); // NTAG216 имеет 888 байт
                this.view = new DataView(this.data);
                this.offset = 0;
            }

            writeByte(value) {
                this.view.setUint8(this.offset, value);
                this.offset++;
            }

            writeBytes(array) {
                for (let i = 0; i < array.length; i++) {
                    this.writeByte(array[i]);
                }
            }

            writeUint16(value) {
                this.view.setUint16(this.offset, value, false); // Big-endian
                this.offset += 2;
            }

            writeString(str, encoding = 'UTF-8') {
                let encoder = new TextEncoder(encoding.toLowerCase());
                let bytes = encoder.encode(str);
                this.writeByte(bytes.length);
                this.writeBytes(Array.from(bytes));
            }

            writeUri(uri) {
                // Определяем код префикса URI
                let prefixCode = 0x00;
                const prefixes = {
                    'http://www.': 0x01,
                    'https://www.': 0x02,
                    'http://': 0x03,
                    'https://': 0x04,
                    'tel:': 0x05,
                    'mailto:': 0x06,
                    'ftp://': 0x07
                };

                for (const [prefix, code] of Object.entries(prefixes)) {
                    if (uri.startsWith(prefix)) {
                        prefixCode = code;
                        uri = uri.substring(prefix.length);
                        break;
                    }
                }

                this.writeByte(prefixCode);
                this.writeString(uri);
            }

            getData() {
                return new Uint8Array(this.data.slice(0, this.offset));
            }

            getHexString() {
                const bytes = this.getData();
                let hex = '';
                for (let i = 0; i < bytes.length; i++) {
                    hex += bytes[i].toString(16).padStart(2, '0').toUpperCase() + ' ';
                    if ((i + 1) % 16 === 0) hex += '\n';
                }
                return hex;
            }
        }

        // Функция для создания записи SmartPoster
        function createSmartPosterRecord(config) {
            const generator = new BinGenerator();
            
            // NDEF Header для SmartPoster
            generator.writeByte(0xD1); // MB=1, ME=1, CF=0, SR=1, IL=0, TNF=1 (NFC Forum well-known type)
            generator.writeByte(0x01); // Длина типа
            generator.writeByte(0x53); // Тип: 'S' (SmartPoster)
            
            // Начинаем запись полезной нагрузки SmartPoster
            
            // Запись URI (обязательная для SmartPoster)
            generator.writeByte(0x91); // Заголовок записи URI: TNF=1, SR=1
            generator.writeByte(0x01); // Длина типа
            generator.writeByte(0x55); // Тип: 'U' (URI)
            generator.writeUri(config.uri);
            
            // Запись заголовка (Title), если указан
            if (config.title) {
                generator.writeByte(0x91); // Заголовок записи текста
                generator.writeByte(0x01); // Длина типа
                generator.writeByte(0x54); // Тип: 'T' (Text)
                
                // Заголовок текстовой записи
                const statusByte = config.encoding === 'UTF-16' ? 0x80 : 0x00;
                generator.writeByte(statusByte | config.language.length);
                generator.writeString(config.language, 'UTF-8');
                generator.writeString(config.title, config.encoding);
            }
            
            // Запись действия (Action)
            const actionValue = parseInt(config.action);
            generator.writeByte(0x91); // Заголовок записи действия
            generator.writeByte(0x03); // Длина типа
            generator.writeByte(0x61); // 'a'
            generator.writeByte(0x63); // 'c'
            generator.writeByte(0x74); // 't'
            generator.writeByte(actionValue); // Значение действия
            
            // Запись MIME типа
            if (config.mimeType) {
                generator.writeByte(0x91); // Заголовок записи типа
                generator.writeByte(0x01); // Длина типа
                generator.writeByte(0x74); // Тип: 't'
                generator.writeString(config.mimeType);
            }
            
            // Запись размера
            const size = parseInt(config.size) || 0;
            if (size > 0) {
                generator.writeByte(0x91); // Заголовок записи размера
                generator.writeByte(0x01); // Длина типа
                generator.writeByte(0x73); // Тип: 's'
                generator.writeByte((size >> 24) & 0xFF);
                generator.writeByte((size >> 16) & 0xFF);
                generator.writeByte((size >> 8) & 0xFF);
                generator.writeByte(size & 0xFF);
            }
            
            // Запись иконки (опционально)
            if (config.includeIcon && config.iconUri) {
                generator.writeByte(0x91); // Заголовок записи иконки
                generator.writeByte(0x01); // Длина типа
                generator.writeByte(0x69); // Тип: 'i' (icon)
                generator.writeUri(config.iconUri);
            }
            
            return generator;
        }

        // Функция генерации .bin файла
        function generateBinFile() {
            try {
                // Сбор данных из формы
                const config = {
                    uri: document.getElementById('uri').value.trim(),
                    title: document.getElementById('title').value.trim(),
                    action: document.getElementById('action').value,
                    mimeType: document.getElementById('mimeType').value.trim(),
                    language: document.getElementById('language').value.trim() || 'en',
                    size: document.getElementById('size').value.trim(),
                    encoding: document.getElementById('encoding').value,
                    includeIcon: document.getElementById('includeIcon').checked,
                    iconUri: document.getElementById('iconUri').value.trim(),
                    readOnly: document.getElementById('readOnly').checked
                };

                // Валидация
                if (!config.uri) {
                    showMessage('Пожалуйста, укажите URI', 'error');
                    return;
                }

                // Создание записи SmartPoster
                const generator = createSmartPosterRecord(config);
                const binData = generator.getData();
                
                // Добавление заголовка NTAG216 (Capability Container)
                const fullData = new Uint8Array(888); // Полный размер NTAG216
                
                // Capability Container (стандартный для NTAG216)
                fullData[0] = 0xE1; // Magic Number
                fullData[1] = 0x10; // Version 1.0
                fullData[2] = 0x6D; // Memory size in bytes / 8 (888/8=111=0x6D)
                fullData[3] = config.readOnly ? 0xBD : 0x00; // Read/Write access
                
                // Копирование данных NDEF
                fullData.set(binData, 4); // Начинаем с 4-го байта
                
                // Создание blob и скачивание файла
                const blob = new Blob([fullData], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ntag216_smartposter.bin';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Показ hex предпросмотра
                showHexPreview(fullData);
                
                showMessage('Файл успешно сгенерирован и скачан!', 'success');
                
            } catch (error) {
                console.error('Ошибка генерации:', error);
                showMessage('Ошибка при генерации файла: ' + error.message, 'error');
            }
        }

        // Функция предпросмотра структуры
        function previewStructure() {
            const config = {
                uri: document.getElementById('uri').value.trim(),
                title: document.getElementById('title').value.trim(),
                action: document.getElementById('action').value,
                mimeType: document.getElementById('mimeType').value.trim(),
                language: document.getElementById('language').value.trim() || 'en',
                size: document.getElementById('size').value.trim(),
                encoding: document.getElementById('encoding').value,
                includeIcon: document.getElementById('includeIcon').checked,
                iconUri: document.getElementById('iconUri').value.trim(),
                readOnly: document.getElementById('readOnly').checked
            };

            let structure = 'NDEF SmartPoster структура:\n\n';
            structure += '1. Запись SmartPoster:\n';
            structure += `   URI: ${config.uri}\n`;
            
            if (config.title) {
                structure += `   Заголовок: ${config.title} (${config.language})\n`;
            }
            
            structure += `   Действие: ${document.getElementById('action').options[document.getElementById('action').selectedIndex].text}\n`;
            
            if (config.mimeType) {
                structure += `   MIME тип: ${config.mimeType}\n`;
            }
            
            if (config.size) {
                structure += `   Размер: ${config.size} байт\n`;
            }
            
            if (config.includeIcon && config.iconUri) {
                structure += `   Иконка: ${config.iconUri}\n`;
            }
            
            structure += `   Режим: ${config.readOnly ? 'Только чтение' : 'Чтение/Запись'}\n\n`;
            
            structure += '2. Технические детали:\n';
            structure += '   Тип записи: SmartPoster (0x53)\n';
            structure += '   TNF: NFC Forum well-known type (0x01)\n';
            structure += '   Размер метки: NTAG216 (888 байт)\n';
            structure += '   Capability Container: включен\n';
            
            document.getElementById('structurePreview').textContent = structure;
            document.getElementById('previewSection').style.display = 'block';
            
            showMessage('Структура сгенерирована', 'success');
        }

        // Функция показа hex предпросмотра
        function showHexPreview(data) {
            const hexPreview = document.getElementById('hexPreview');
            let html = '';
            
            // Показываем первые 256 байт для предпросмотра
            const previewLength = Math.min(256, data.length);
            
            for (let i = 0; i < previewLength; i += 16) {
                const row = data.slice(i, Math.min(i + 16, previewLength));
                
                // Offset
                html += `<div class="hex-row">
                    <div class="hex-offset">${i.toString(16).toUpperCase().padStart(4, '0')}</div>
                    <div class="hex-bytes">`;
                
                // Hex bytes
                for (let j = 0; j < 16; j++) {
                    if (i + j < previewLength) {
                        html += `<span class="hex-byte">${row[j].toString(16).padStart(2, '0').toUpperCase()}</span>`;
                    } else {
                        html += '<span class="hex-byte">  </span>';
                    }
                }
                
                html += '</div><div class="hex-ascii">';
                
                // ASCII representation
                for (let j = 0; j < row.length; j++) {
                    const byte = row[j];
                    if (byte >= 32 && byte <= 126) {
                        html += String.fromCharCode(byte);
                    } else {
                        html += '.';
                    }
                }
                
                html += '</div></div>';
            }
            
            hexPreview.innerHTML = html;
            document.getElementById('hexPreviewSection').style.display = 'block';
        }

        // Функция показа сообщений
        function showMessage(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            
            // Автоскрытие через 5 секунд
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }

        // Функция сброса формы
        function resetForm() {
            if (confirm('Вы уверены, что хотите сбросить все поля?')) {
                document.getElementById('uri').value = 'https://www.google.com';
                document.getElementById('title').value = 'Открыть Google';
                document.getElementById('action').value = '0x00';
                document.getElementById('mimeType').value = 'text/html';
                document.getElementById('language').value = 'ru';
                document.getElementById('size').value = '1024';
                document.getElementById('encoding').value = 'UTF-8';
                document.getElementById('includeIcon').checked = true;
                document.getElementById('iconUri').value = 'https://www.google.com/favicon.ico';
                document.getElementById('readOnly').checked = true;
                
                document.getElementById('previewSection').style.display = 'none';
                document.getElementById('hexPreviewSection').style.display = 'none';
                showMessage('Форма сброшена', 'success');
            }
        }

        // Пример данных по умолчанию
        document.addEventListener('DOMContentLoaded', function() {
            showMessage('Заполните форму для генерации файла SmartPoster', 'success');
        });
    </script>
</body>
</html>