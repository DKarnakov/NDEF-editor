<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTAG BIN Generator для Chameleon Ultra</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --text-color: #212529;
            --danger-color: #dc3545;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: var(--bg-color); color: var(--text-color); }
        .main-container { max-width: 900px; margin: 0 auto; }
        h1, h2 { color: #333; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-header { padding: 15px 20px; background-color: #f7f7f9; border-bottom: 1px solid var(--border-color); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 500; margin-bottom: 6px; }
        input, select, textarea {
            width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1rem;
        }
        button {
            display: inline-block; background-color: var(--primary-color); color: white; padding: 10px 18px; border: none;
            border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: background-color 0.2s;
        }
        button:hover { background-color: #0056b3; }
        button.danger { background-color: var(--danger-color); }
        button.danger:hover { background-color: #c82333; }
        .controls { display: flex; gap: 10px; align-items: flex-end; }
        #records-container .card-header { cursor: grab; }
        #status-bar { padding: 15px; background-color: #e9ecef; border-radius: 8px; margin-top: 20px; font-weight: 500; transition: color 0.3s; }
        .uri-type-options { border: 1px dashed #ccc; padding: 15px; border-radius: 5px; margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="main-container">
        <h1>NTAG .BIN Генератор</h1>

        <div class="card">
            <div class="card-header">Настройки метки и генерация</div>
            <div class="card-body">
                <div class="form-group">
                    <label for="ntag-version">Версия NTAG:</label>
                    <select id="ntag-version">
                        <option value="216">NTAG216 (888 байт)</option>
                        <option value="215">NTAG215 (504 байта)</option>
                        <option value="213">NTAG213 (144 байта)</option>
                    </select>
                </div>
                <button id="generate-btn">Сгенерировать .bin файл</button>
                <div id="status-bar">
                    <span>Размер данных: <b id="data-size">0</b> байт</span> |
                    <span>Емкость метки: <b id="tag-capacity">888</b> байт</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Редактор NDEF Записей</div>
            <div class="card-body">
                <div id="records-container"></div>
                <div class="controls">
                    <div class="form-group" style="flex-grow: 1;">
                        <label for="record-type">Тип новой записи:</label>
                        <select id="record-type">
                            <option value="uri">URI (Ссылка)</option>
                            <option value="text">Text (Текст)</option>
                            <option value="vcard">vCard (Визитка)</option>
                            <option value="wifi">Wi-Fi</option>
                            <option value="bt">Bluetooth OOB</option>
                        </select>
                    </div>
                    <button id="add-record-btn">Добавить запись</button>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM fully loaded and parsed. Initializing script.");

    // --- GLOBAL STATE AND CONSTANTS ---
    const NTAG_SPECS = {
        '213': { user: 144, total: 180 },
        '215': { user: 504, total: 540 },
        '216': { user: 888, total: 924 },
    };
    let records = [];
    let recordIdCounter = 0;
    const textEncoder = new TextEncoder();

    // --- DOM ELEMENTS ---
    const ntagVersionSelect = document.getElementById('ntag-version');
    const generateBtn = document.getElementById('generate-btn');
    const addRecordBtn = document.getElementById('add-record-btn');
    const newRecordTypeSelect = document.getElementById('record-type');
    const recordsContainer = document.getElementById('records-container');
    const dataSizeEl = document.getElementById('data-size');
    const tagCapacityEl = document.getElementById('tag-capacity');
    const statusBarEl = document.getElementById('status-bar'); // *** FIX: Correctly get the status bar element ***

    // --- NDEF RECORD BUILDERS ---
    function createNdefRecord(tnf, type, payload) {
        const isShort = payload.length < 256;
        const headerSize = 1 + 1 + (isShort ? 1 : 4) + type.length;
        const header = new Uint8Array(headerSize);
        let offset = 0;
        header[offset++] = (tnf & 0x07) | (isShort ? 0x10 : 0x00);
        header[offset++] = type.length;
        if (isShort) {
            header[offset++] = payload.length;
        } else {
            const view = new DataView(header.buffer);
            view.setUint32(offset, payload.length, false);
            offset += 4;
        }
        header.set(type, offset);
        const fullRecord = new Uint8Array(header.length + payload.length);
        fullRecord.set(header);
        fullRecord.set(payload, header.length);
        return fullRecord;
    }

    function buildUriRecord(data) {
        console.log("Building URI record with data:", data);
        let fullUri = "";
        const protocol = data.protocol || 'uri';

        if (protocol === 'uri') {
            fullUri = data.uri_main || '';
        } else if (protocol === 'tel') {
            fullUri = `tel:${data.uri_tel || ''}`;
        } else if (protocol === 'mailto') {
            fullUri = `mailto:${data.mail_to || ''}?subject=${encodeURIComponent(data.mail_subject || '')}&body=${encodeURIComponent(data.mail_body || '')}`;
        } else if (protocol === 'sms') {
            fullUri = `sms:${data.sms_tel || ''}?body=${encodeURIComponent(data.sms_body || '')}`;
        } else if (protocol === 'geo') {
            fullUri = `geo:${data.geo_lat || 0},${data.geo_lon || 0}`;
        }
        console.log(`  > Final URI string: ${fullUri}`);
        const uriPrefixes = ["", "http://www.", "https://www.", "http://", "https://", "tel:", "mailto:", "ftp://anonymous:anonymous@", "ftp://ftp.", "ftps://", "sftp://", "smb://", "nfs://", "ftp://", "dav://", "news:", "telnet://", "imap:", "rtsp://", "urn:", "pop:", "sip:", "sips:", "tftp:", "btspp://", "btl2cap://", "btgoep://", "tcpobex://", "irdaobex://", "file://", "urn:epc:id:", "urn:epc:tag:", "urn:epc:pat:", "urn:epc:raw:", "urn:epc:", "urn:nfc:"];
        let prefixCode = 0;
        for (let i = 1; i < uriPrefixes.length; i++) {
            if (fullUri.startsWith(uriPrefixes[i])) {
                prefixCode = i;
                fullUri = fullUri.substring(uriPrefixes[i].length);
                break;
            }
        }
        const uriBytes = textEncoder.encode(fullUri);
        const payload = new Uint8Array(1 + uriBytes.length);
        payload[0] = prefixCode;
        payload.set(uriBytes, 1);
        return createNdefRecord(0x01, textEncoder.encode("U"), payload);
    }
    
    // Other build functions (vCard, Text, WiFi, BT) remain the same as before
    // They are assumed to be correct for this fix.
    function buildTextRecord({ text, lang }) {
        const langBytes = textEncoder.encode(lang);
        const textBytes = textEncoder.encode(text);
        const status = langBytes.length;
        const payload = new Uint8Array(1 + langBytes.length + textBytes.length);
        payload[0] = status;
        payload.set(langBytes, 1);
        payload.set(textBytes, 1 + langBytes.length);
        return createNdefRecord(0x01, textEncoder.encode("T"), payload);
    }

    function buildVCardRecord(data) {
        let vcard = "BEGIN:VCARD\nVERSION:4.0\n";
        const fn = [data.fn_first, data.fn_middle, data.fn_last].filter(Boolean).join(' ');
        vcard += `FN:${fn}\n`;
        vcard += `N:${data.fn_last || ''};${data.fn_first || ''};${data.fn_middle || ''};${data.fn_prefix || ''};${data.fn_suffix || ''}\n`;
        if (data.org) vcard += `ORG:${data.org}\n`;
        if (data.title) vcard += `TITLE:${data.title}\n`;
        if (data.photo_uri) vcard += `PHOTO;VALUE=uri:${data.photo_uri}\n`;
        if (data.tel_work) vcard += `TEL;TYPE=work,voice;VALUE=uri:tel:${data.tel_work}\n`;
        if (data.tel_cell) vcard += `TEL;TYPE=cell,voice;VALUE=uri:tel:${data.tel_cell}\n`;
        if (data.email) vcard += `EMAIL:${data.email}\n`;
        if (data.website) vcard += `URL:${data.website}\n`;

        let adr = '';
        if (data.adr_street || data.adr_city || data.adr_state || data.adr_zip || data.adr_country) {
             adr = `;;${data.adr_street || ''};${data.adr_city || ''};${data.adr_state || ''};${data.adr_zip || ''};${data.adr_country || ''}`;
             vcard += `ADR;TYPE=work:${adr}\n`;
        }
        vcard += "END:VCARD";
        const payload = textEncoder.encode(vcard);
        return createNdefRecord(0x02, textEncoder.encode("text/vcard"), payload);
    }

    function buildWifiRecord({ ssid, password, auth }) {
        if (auth === 'nopass') password = '';
        const wifiString = `WIFI:S:${ssid || ''};T:${auth || 'nopass'};P:${password || ''};;`;
        // Wi-Fi config is not a standard URI, it's a specific format handled by many phones
        // It's often encoded in a MIME type record for correctness, but URI type is widely compatible.
        // Let's use MIME for better standards compliance.
        const payload = textEncoder.encode(wifiString);
        return createNdefRecord(0x02, textEncoder.encode("application/vnd.wfa.wsc"), payload);
    }

    function buildBluetoothRecord({ mac, name }) {
        if (!mac) return null;
        const macBytes = mac.split(/[:\s-]/).map(hex => parseInt(hex, 16));
        if (macBytes.length !== 6 || macBytes.some(isNaN)) {
            console.error('Invalid MAC address format:', mac);
            alert('Неверный формат MAC-адреса. Используйте XX:XX:XX:XX:XX:XX.');
            return null;
        }
        
        const nameBytes = textEncoder.encode(name || '');
        const payload = new Uint8Array(2 + 6 + (name ? (2 + nameBytes.length) : 0));
        const view = new DataView(payload.buffer);
        
        let offset = 0;
        view.setUint16(offset, 6 + (name ? (2 + nameBytes.length) : 0), true); // Length of OOB data
        offset += 2;
        
        payload.set(macBytes.reverse(), offset); // MAC is Little-Endian in OOB
        offset += 6;
        
        if (name) {
            payload[offset++] = nameBytes.length + 1; // Length of this part
            payload[offset++] = 0x09; // Type: Complete Local Name
            payload.set(nameBytes, offset);
        }
        return createNdefRecord(0x02, textEncoder.encode("application/vnd.bluetooth.ep.oob"), payload);
    }
    
    // --- UI TEMPLATE GENERATORS ---
    function getRecordHtml(id, type) {
        console.log(`Generating HTML for new record ID: ${id}, Type: ${type}`);
        const commonHeader = `<div class="card" data-id="${id}" data-type="${type}"><div class="card-header"><span>${type.toUpperCase()} Запись</span><button class="danger" onclick="removeRecord(${id})">Удалить</button></div><div class="card-body">`;
        const commonFooter = `</div></div>`;
        let content = '';
        switch (type) {
            case 'uri':
                content = `
                    <div class="form-group">
                        <label>Тип URI</label>
                        <select class="uri-protocol-select" onchange="window.handleUriProtocolChange(this)">
                            <option value="uri" selected>URL (http/https)</option>
                            <option value="tel">Телефон (tel:)</option>
                            <option value="mailto">Email (mailto:)</option>
                            <option value="sms">SMS</option>
                            <option value="geo">Гео-метка (geo:)</option>
                        </select>
                    </div>
                    <div class="uri-type-options">
                        <div class="form-group uri-option" data-protocol="uri">
                            <label>URL</label><input type="text" data-field="uri_main" placeholder="https://example.com">
                        </div>
                        <div class="form-group uri-option hidden" data-protocol="tel">
                            <label>Номер телефона</label><input type="text" data-field="uri_tel" placeholder="+79123456789">
                        </div>
                         <div class="uri-option hidden" data-protocol="mailto">
                            <div class="form-group"><label>Кому (Email)</label><input type="email" data-field="mail_to"></div>
                            <div class="form-group"><label>Тема</label><input type="text" data-field="mail_subject"></div>
                            <div class="form-group"><label>Сообщение</label><textarea data-field="mail_body"></textarea></div>
                        </div>
                        <div class="uri-option hidden" data-protocol="sms">
                            <div class="form-group"><label>Номер телефона</label><input type="tel" data-field="sms_tel"></div>
                            <div class="form-group"><label>Сообщение</label><textarea data-field="sms_body"></textarea></div>
                        </div>
                        <div class="uri-option hidden" data-protocol="geo">
                            <div class="form-group"><label>Широта</label><input type="text" data-field="geo_lat" placeholder="55.7558"></div>
                            <div class="form-group"><label>Долгота</label><input type="text" data-field="geo_lon" placeholder="37.6173"></div>
                        </div>
                    </div>`;
                break;
            // Other cases remain the same. I've copy-pasted them for completeness.
            case 'text':
                content = `<div class="form-group"><label>Текст</label><textarea data-field="text"></textarea></div><div class="form-group"><label>Код языка</label><input type="text" data-field="lang" value="ru" placeholder="en, ru..."></div>`;
                break;
            case 'vcard':
                content = `<b>Имя</b><div class="form-group"><label>Имя</label><input type="text" data-field="fn_first"></div><div class="form-group"><label>Фамилия</label><input type="text" data-field="fn_last"></div><div class="form-group"><label>Отчество</label><input type="text" data-field="fn_middle"></div><b>Работа</b><div class="form-group"><label>Организация</label><input type="text" data-field="org"></div><div class="form-group"><label>Должность</label><input type="text" data-field="title"></div><b>Контакты</b><div class="form-group"><label>Рабочий телефон</label><input type="tel" data-field="tel_work"></div><div class="form-group"><label>Мобильный телефон</label><input type="tel" data-field="tel_cell"></div><div class="form-group"><label>Email</label><input type="email" data-field="email"></div><div class="form-group"><label>Веб-сайт</label><input type="url" data-field="website"></div><b>Адрес</b><div class="form-group"><label>Улица, дом</label><input type="text" data-field="adr_street"></div><div class="form-group"><label>Город</label><input type="text" data-field="adr_city"></div><div class="form-group"><label>Регион</label><input type="text" data-field="adr_state"></div><div class="form-group"><label>Индекс</label><input type="text" data-field="adr_zip"></div><div class="form-group"><label>Страна</label><input type="text" data-field="adr_country"></div><b>Фото</b><div class="form-group"><label>URL фотографии</label><input type="url" data-field="photo_uri" placeholder="https://example.com/photo.jpg"></div>`;
                break;
            case 'wifi':
                content = `<div class="form-group"><label>Имя сети (SSID)</label><input type="text" data-field="ssid"></div><div class="form-group"><label>Тип аутентификации</label><select data-field="auth"><option value="WPA">WPA/WPA2</option><option value="WEP">WEP</option><option value="nopass">Открытая сеть</option></select></div><div class="form-group"><label>Пароль</label><input type="password" data-field="password"></div>`;
                break;
            case 'bt':
                content = `<div class="form-group"><label>MAC-адрес</label><input type="text" data-field="mac" placeholder="00:11:22:AA:BB:CC"></div><div class="form-group"><label>Имя устройства</label><input type="text" data-field="name"></div>`;
                break;
        }
        return commonHeader + content + commonFooter;
    }

    // --- UI AND EVENT HANDLERS ---
    window.handleUriProtocolChange = function(selectElement) {
        const cardBody = selectElement.closest('.card-body');
        const selectedProtocol = selectElement.value;
        console.log(`URI protocol changed to: ${selectedProtocol}`);
        cardBody.querySelectorAll('.uri-option').forEach(opt => {
            opt.classList.toggle('hidden', opt.dataset.protocol !== selectedProtocol);
        });
    }

    function addRecord() {
        console.log("Add Record button clicked");
        const type = newRecordTypeSelect.value;
        const newRecord = { id: recordIdCounter++, type: type, data: {} };
        records.push(newRecord);
        const recordEl = document.createElement('div');
        recordEl.innerHTML = getRecordHtml(newRecord.id, newRecord.type);
        recordsContainer.appendChild(recordEl.firstChild);
        attachInputListeners();
        updateStatus(); // Update status after adding and attaching listeners
    }

    window.removeRecord = function(id) {
        console.log(`Remove Record button clicked for ID: ${id}`);
        records = records.filter(rec => rec.id !== id);
        const recordEl = recordsContainer.querySelector(`.card[data-id="${id}"]`);
        if (recordEl) recordEl.remove();
        updateStatus();
    }

    function attachInputListeners() {
        console.log("Attaching input listeners to all fields.");
        recordsContainer.querySelectorAll('input, select, textarea').forEach(input => {
            input.removeEventListener('input', updateStatus); // Avoid duplicate listeners
            input.addEventListener('input', updateStatus);
        });
    }

    function gatherDataFromUI() {
        console.log("Gathering data from UI...");
        const currentRecords = [];
        recordsContainer.querySelectorAll('.card').forEach(cardEl => {
            const id = parseInt(cardEl.dataset.id, 10);
            const type = cardEl.dataset.type;
            const data = {};
            
            if (type === 'uri') {
                data.protocol = cardEl.querySelector('.uri-protocol-select').value;
            }
            cardEl.querySelectorAll('[data-field]').forEach(input => {
                // *** FIX: Only gather data from VISIBLE inputs ***
                if (!input.closest('.hidden')) {
                    data[input.dataset.field] = input.value;
                }
            });
            currentRecords.push({ id, type, data });
        });
        console.log("  > Gathered data:", currentRecords);
        return currentRecords;
    }

    function buildNdefMessageBytes(recordData) {
        console.log("Building NDEF message from record data...");
        if (!recordData.length) return new Uint8Array(0);
        const recordBytesList = recordData.map(rec => {
            switch (rec.type) {
                case 'uri': return buildUriRecord(rec.data);
                case 'text': return buildTextRecord(rec.data);
                case 'vcard': return buildVCardRecord(rec.data);
                case 'wifi': return buildWifiRecord(rec.data);
                case 'bt': return buildBluetoothRecord(rec.data);
                default: return null;
            }
        }).filter(Boolean);
        if (recordBytesList.length > 0) {
            recordBytesList[0][0] |= 0x80;
            recordBytesList[recordBytesList.length - 1][0] |= 0x40;
        }
        const totalLength = recordBytesList.reduce((sum, r) => sum + r.length, 0);
        const fullPayload = new Uint8Array(totalLength);
        let offset = 0;
        recordBytesList.forEach(r => {
            fullPayload.set(r, offset);
            offset += r.length;
        });
        console.log(`  > NDEF message built. Total length: ${fullPayload.length} bytes.`);
        return fullPayload;
    }

    function updateStatus() {
        console.log("Updating status...");
        const currentData = gatherDataFromUI();
        const ndefPayload = buildNdefMessageBytes(currentData);
        const messageTlvSize = ndefPayload.length > 0 ? (2 + ndefPayload.length + 1) : 0;
        const selectedVersion = ntagVersionSelect.value;
        const capacity = NTAG_SPECS[selectedVersion].user;
        dataSizeEl.textContent = messageTlvSize;
        tagCapacityEl.textContent = capacity;

        // *** FIX: Use correct variable name for the status bar element ***
        if (messageTlvSize > capacity) {
            statusBarEl.style.color = 'var(--danger-color)';
        } else {
            statusBarEl.style.color = 'var(--text-color)';
        }
        console.log(`  > Status updated: Size=${messageTlvSize}, Capacity=${capacity}`);
    }

    function generateBinFile() {
        console.log("Generate BIN button clicked.");
        updateStatus(); // Ensure data is fresh before generating
        const currentData = gatherDataFromUI();
        if (!currentData.length) {
            alert("Нет записей для генерации файла.");
            return;
        }
        const ndefPayload = buildNdefMessageBytes(currentData);
        if (!ndefPayload.length) {
            alert("Не удалось создать NDEF данные. Проверьте поля, например, MAC-адрес.");
            return;
        }
        const ndefMessageWithTlv = new Uint8Array(2 + ndefPayload.length + 1);
        ndefMessageWithTlv[0] = 0x03;
        ndefMessageWithTlv[1] = ndefPayload.length;
        ndefMessageWithTlv.set(ndefPayload, 2);
        ndefMessageWithTlv[ndefMessageWithTlv.length - 1] = 0xFE;

        let currentVersion = ntagVersionSelect.value;
        let capacity = NTAG_SPECS[currentVersion].user;

        if (ndefMessageWithTlv.length > capacity) {
            let newVersion = null;
            if (currentVersion === '213' && ndefMessageWithTlv.length <= NTAG_SPECS['215'].user) newVersion = '215';
            else if ((currentVersion === '213' || currentVersion === '215') && ndefMessageWithTlv.length <= NTAG_SPECS['216'].user) newVersion = '216';
            
            if (newVersion) {
                if (confirm(`Размер данных (${ndefMessageWithTlv.length} байт) превышает емкость NTAG${currentVersion}. Хотите переключиться на NTAG${newVersion}?`)) {
                    ntagVersionSelect.value = newVersion;
                    currentVersion = newVersion;
                    updateStatus(); // Update capacity display
                } else {
                    return;
                }
            } else {
                alert(`Ошибка: Размер данных (${ndefMessageWithTlv.length} байт) превышает максимальную емкость NTAG216.`);
                return;
            }
        }
        
        const finalSpec = NTAG_SPECS[currentVersion];
        const memoryDump = new Uint8Array(finalSpec.total).fill(0);
        memoryDump.set([0x04, 0x12, 0x34, 0x56], 0);
        memoryDump.set([0x78, 0x90, 0xAB, 0xCD], 4);
        memoryDump.set([0x00, 0x00, 0x48, 0x00], 8);
        const ccSize = Math.floor(finalSpec.user / 8);
        memoryDump.set([0xE1, 0x10, ccSize, 0x00], 12);
        memoryDump.set(ndefMessageWithTlv, 16);

        const blob = new Blob([memoryDump], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ntag${currentVersion}.bin`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        console.log(`Successfully generated and downloaded ntag${currentVersion}.bin`);
    }

    // --- INITIALIZATION ---
    addRecordBtn.addEventListener('click', addRecord);
    generateBtn.addEventListener('click', generateBinFile);
    ntagVersionSelect.addEventListener('change', updateStatus);

    updateStatus(); // Initial status check
});
</script>
</body>
</html>
