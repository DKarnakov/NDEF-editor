<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>vCard Generator</title>
</head>
<body>

<script>
    function generateVCard() {
        // --- Карта для расшифровки коротких параметров ---
        const map = {
            l: 'n_last', f: 'n_first', m: 'n_middle', nn: 'nickname',
            b: 'bday', p: 'photo',
            as: 'adr_street', aci: 'adr_city', ar: 'adr_region', az: 'adr_zip', aco: 'adr_country',
            tc: 'tel_cell', tw: 'tel_work', th: 'tel_home',
            ew: 'email_work', eh: 'email_home', u: 'url',
            o: 'org', t: 'title', r: 'role',
            no: 'note'
            // Пользовательские поля X- передаются как есть
        };

        const params = new URLSearchParams(window.location.search);
        const data = {};
        for (const [key, value] of params.entries()) {
            const longKey = map[key] || key; // Если ключа нет в карте, используем его как есть (для X- полей)
            data[longKey] = value;
        }

        let vCard = "BEGIN:VCARD\n";
        vCard += "VERSION:3.0\n";

        // --- Генерация FN и N ---
        const n_parts = [data.n_last || '', data.n_first || '', data.n_middle || '', '', ''];
        const fn_parts = [data.n_last, data.n_first, data.n_middle].filter(Boolean); // Отфильтровываем пустые значения
        if (fn_parts.length > 0) {
            vCard += `FN;CHARSET=UTF-8:${fn_parts.join(' ')}\n`;
            vCard += `N;CHARSET=UTF-8:${n_parts.join(';')}\n`;
        }
        
        if (data.nickname) vCard += `NICKNAME;CHARSET=UTF-8:${data.nickname}\n`;
        if (data.photo) vCard += `PHOTO;VALUE=URL:${data.photo}\n`;
        if (data.bday) vCard += `BDAY:${data.bday}\n`;

        // --- Адрес (теперь рабочий) ---
        const adr_parts = [data.adr_street, data.adr_city, data.adr_region, data.adr_zip, data.adr_country];
        if (adr_parts.some(Boolean)) {
            vCard += `ADR;TYPE=WORK;CHARSET=UTF-8:;;${adr_parts.join(';')}\n`;
        }

        // --- Телефоны ---
        if (data.tel_cell) vCard += `TEL;TYPE=CELL,VOICE:${data.tel_cell}\n`;
        if (data.tel_work) vCard += `TEL;TYPE=WORK,VOICE:${data.tel_work}\n`;
        if (data.tel_home) vCard += `TEL;TYPE=HOME,VOICE:${data.tel_home}\n`;

        // --- Email и Web ---
        if (data.email_work) vCard += `EMAIL;TYPE=PREF,INTERNET:${data.email_work}\n`;
        if (data.email_home) vCard += `EMAIL;TYPE=INTERNET:${data.email_home}\n`;
        if (data.url) vCard += `URL:${data.url}\n`;

        // --- Работа ---
        if (data.title) vCard += `TITLE;CHARSET=UTF-8:${data.title}\n`;
        if (data.role) vCard += `ROLE;CHARSET=UTF-8:${data.role}\n`;
        if (data.org) vCard += `ORG;CHARSET=UTF-8:${data.org}\n`;

        // --- Прочие поля ---
        if (data.note) vCard += `NOTE;CHARSET=UTF-8:${data.note}\n`;
        vCard += `REV:${new Date().toISOString()}\n`;
        
        // --- Пользовательские поля ---
        for (const key in data) {
            if (key.toLowerCase().startsWith('x-')) {
                vCard += `${key.toUpperCase()};CHARSET=UTF-8:${data[key]}\n`;
            }
        }
        
        vCard += "END:VCARD";

        const blob = new Blob([vCard], { type: 'text/vcard;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        const fileName = fn_parts.length > 0 ? `${fn_parts.join('_')}.vcf` : 'contact.vcf';
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    window.onload = generateVCard;
</script>

</body>
</html>