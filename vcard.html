<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>vCard 3.0 Generator</title>
</head>
<body>

<script>
    function generateVCard() {
        const params = new URLSearchParams(window.location.search);
        
        // --- vCard 3.0 (RFC 2426) ---
        // Используем CHARSET=UTF-8 для текстовых полей, как требует стандарт.
        let vCard = "BEGIN:VCARD\n";
        vCard += "VERSION:3.0\n";

        // --- Имена ---
        // FN (Formatted Name) и N (Name)
        if (params.has('fn')) vCard += `FN;CHARSET=UTF-8:${params.get('fn')}\n`;
        if (params.has('n')) vCard += `N;CHARSET=UTF-8:${params.get('n')}\n`;
        
        if (params.has('nickname')) vCard += `NICKNAME;CHARSET=UTF-8:${params.get('nickname')}\n`;

        // --- Фото и дата рождения ---
        if (params.has('photo')) vCard += `PHOTO;VALUE=URL:${params.get('photo')}\n`;
        if (params.has('bday')) vCard += `BDAY:${params.get('bday')}\n`; // YYYY-MM-DD

        // --- Адрес ---
        // ADR: ;;улица;город;регион;индекс;страна
        if (params.has('adr')) vCard += `ADR;TYPE=HOME;CHARSET=UTF-8:;;${params.get('adr')}\n`;

        // --- Телефоны (формат vCard 3.0) ---
        if (params.has('tel_cell')) vCard += `TEL;TYPE=CELL,VOICE:${params.get('tel_cell')}\n`;
        if (params.has('tel_work')) vCard += `TEL;TYPE=WORK,VOICE:${params.get('tel_work')}\n`;
        if (params.has('tel_home')) vCard += `TEL;TYPE=HOME,VOICE:${params.get('tel_home')}\n`;

        // --- Электронная почта и веб ---
        if (params.has('email_work')) vCard += `EMAIL;TYPE=PREF,INTERNET:${params.get('email_work')}\n`;
        if (params.has('email_home')) vCard += `EMAIL;TYPE=INTERNET:${params.get('email_home')}\n`;
        if (params.has('url')) vCard += `URL:${params.get('url')}\n`;

        // --- Работа ---
        if (params.has('title')) vCard += `TITLE;CHARSET=UTF-8:${params.get('title')}\n`;
        if (params.has('role')) vCard += `ROLE;CHARSET=UTF-8:${params.get('role')}\n`;
        if (params.has('org')) vCard += `ORG;CHARSET=UTF-8:${params.get('org')}\n`;

        // --- Прочие поля ---
        if (params.has('note')) vCard += `NOTE;CHARSET=UTF-8:${params.get('note')}\n`;
        if (params.has('tz')) vCard += `TZ:${params.get('tz')}\n`;
        if (params.has('geo')) {
            // В v3.0 разделитель - точка с запятой
            const geoVal = params.get('geo').replace(/,/g, ';');
            vCard += `GEO:${geoVal}\n`;
        }
        vCard += `REV:${new Date().toISOString()}\n`;

        // --- Пользовательские поля (X-name) ---
        params.forEach((value, key) => {
            if (key.toLowerCase().startsWith('x-')) {
                vCard += `${key.toUpperCase()};CHARSET=UTF-8:${value}\n`;
            }
        });

        vCard += "END:VCARD";

        const blob = new Blob([vCard], { type: 'text/vcard;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        const fileName = params.get('fn') ? `${params.get('fn').replace(/ /g, '_')}.vcf` : 'contact.vcf';
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    window.onload = generateVCard;
</script>

</body>
</html>
